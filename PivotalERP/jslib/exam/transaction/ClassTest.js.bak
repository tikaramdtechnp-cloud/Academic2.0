app.controller('ClassTestController', function($scope, $http, $timeout, $filter, GlobalServices) {
    $scope.Title = 'Class Test';
    var gSrv = GlobalServices;
    OnClickDefault();
    $scope.LoadData = function() {

        $('.select2').select2();

        $scope.confirmMSG = GlobalServices.getConfirmMSG();
        $scope.perPageColl = GlobalServices.getPerPageList();
        //$scope.MonthList = GlobalServices.getMonthList();

        $scope.currentPages = {
            ClassTestMarkEntry: 1,
            ClassSummary: 1


        };

        $scope.searchData = {
            ClassTestMarkEntry: '',
            ClassSummary: ''

        };

        $scope.perPage = {
            ClassTestMarkEntry: GlobalServices.getPerPageRow(),
            ClassSummary: GlobalServices.getPerPageRow()

        };

        $scope.ClassList = [];
        $scope.SectionList = [];
        $scope.SectionListWithClass = [];


        $http({
            method: 'POST',
            url: base_url + "Academic/Creation/GetAllClassList",
            dataType: "json"
        }).then(function(res) {
            hidePleaseWait();
            $scope.loadingstatus = "stop";
            if (res.data.IsSuccess && res.data.Data) {
                $scope.ClassList = res.data.Data;

            } else {
                Swal.fire(res.data.ResponseMSG);
            }

        }, function(reason) {
            Swal.fire('Failed' + reason);
        });

        $scope.newFilter = {
            FromDate_TMP: new Date(),
            ToDate_TMP: new Date()

        };


        $scope.newClassMarkEntry = {
            TranId: null,
            AcademicYearId: null,
            ClassId: null,
            SectionId: null,
            EmployeeId: null,
            SubjectId: null,
            LessonId: null,
            StudentId: null,
            BatchId: null,
            SemesterId: null,
            ClassYearId: null,
            TestDate: null,
            FullMarks: null,
            PassMarks: null,
            ObtMarks: null,
            Remarks: '',
            Mode: 'Save'
        };

        $scope.newSummary = {
            SummaryId: null,

            Mode: 'Save'
        };

        $scope.ClearClassMarkEntry = function() {
            $scope.newClassMarkEntry = {
                TranId: null,
                AcademicYearId: null,
                ClassId: null,
                SectionId: null,
                EmployeeId: null,
                SubjectId: null,
                LessonId: null,
                StudentId: null,
                BatchId: null,
                SemesterId: null,
                ClassYearId: null,
                TestDate: null,
                FullMarks: null,
                PassMarks: null,
                ObtMarks: null,
                Remarks: '',
                Mode: 'Save'
            };
        }
        $scope.ClearSummary = function() {
            $scope.newSummary = {
                SummaryId: null,

                Mode: 'Save'
            };


        }

    }


    $scope.ClassList = [];
    gSrv.getClassSectionList().then(function(res) {
        $scope.ClassList = res.data.Data;
    }, function(reason) {
        Swal.fire('Failed' + reason);
    });

    function OnClickDefault() {

        //FOr test summary
        document.getElementById('ClassSummaryForm').style.display = "none";

        document.getElementById('ViewDetails').onclick = function() {
            document.getElementById('ClassSummarySection').style.display = "none";
            document.getElementById('ClassSummaryForm').style.display = "block";
        }

        document.getElementById('back-to-list-ClassSummary').onclick = function() {
            document.getElementById('ClassSummaryForm').style.display = "none";
            document.getElementById('ClassSummarySection').style.display = "block";
        }

    };

    //************************* MarkEntry *********************************

    //$scope.IsValidMarkEntry = function () {
    //	if ($scope.newClassMarkEntry.Name.isEmpty()) {
    //		Swal.fire('Please ! Enter MarkEntry Name');
    //		return false;
    //	}

    //	return true;
    //}

    //$scope.SaveUpdateMarkEntry = function () {
    //	if ($scope.IsValidMarkEntry() == true) {
    //		if ($scope.confirmMSG.Accept == true) {
    //			var saveModify = $scope.newClassMarkEntry.Mode;
    //			Swal.fire({
    //				title: 'Do you want to ' + saveModify + ' the current data?',
    //				showCancelButton: true,
    //				confirmButtonText: saveModify,
    //			}).then((result) => {
    //				/* Read more about isConfirmed, isDenied below */
    //				if (result.isConfirmed) {
    //					$scope.CallSaveUpdateMarkEntry();
    //				}
    //			});
    //		} else
    //			$scope.CallSaveUpdateMarkEntry();

    //	}
    //};

    $scope.SaveClassTestMarkEntry = function() {
        $scope.loadingstatus = "running";
        showPleaseWait();
        var dataToSave = [];

        if ($scope.newClassMarkEntry.TestDate && $scope.newClassMarkEntry.TestDate.dateAD) {
            var testDateAD = $scope.newClassMarkEntry.TestDate.dateAD;

            var parsedDate = Date.parse(testDateAD);
            if (!isNaN(parsedDate)) {
                var forDate = $filter('date')(new Date(parsedDate), 'yyyy-MM-dd');
                console.log("Formatted TestDate:", forDate);
            } else {
                console.error("Invalid date format:", testDateAD);
                forDate = null;
            }
        } else {
            console.error("TestDate or dateAD is not defined");
            forDate = null;
        }
        var classId = $scope.newClassMarkEntry.ClassId;
        var teacherId = $scope.newClassMarkEntry.TeacherId;
        var lessonId = $scope.newClassMarkEntry.LessonId;
        var sectionId = $scope.newClassMarkEntry.SectionId;
        var fullMarks = $scope.newClassMarkEntry.FullMarks;
        var passMarks = $scope.newClassMarkEntry.PassMarks;


        for (var i = 0; i < $scope.StudentsDetailsClassWiseList.length; i++) {
            var S = $scope.StudentsDetailsClassWiseList[i];
            var tranid = S.TranId;
            var classId = S.ClassId;
            var sectionId = S.SectionId;
            var teacherId = S.TeacherId;
            var lessonId = S.LessonId;
            var subjectId = S.SubjectId;
            var batchId = S.BatchId;
            var semesterId = S.SemesterId;
            var classYearId = S.ClassYearId;
            var studentId = S.StudentId;
            //var fullMarks = S.FullMarks;
            //var passMarks = S.PassMarks;
            var obtMarks = S.ObtainMarks;
            var remarks = S.RemarksType;

            var dataItem = {
                TranId: tranid,
                ClassId: 2,
                SectionId: 1,
                EmployeeId: 2,
                SubjectId: 2,
                LessonId: 9,
                StudentId: studentId,
                BatchId: batchId,
                SemesterId: semesterId,
                ClassYearId: classYearId,
                FullMarks: fullMarks,
                PassMarks: passMarks,
                ObtMarks: obtMarks,
                Remarks: remarks,
                ForDate: forDate,
                TestDate: forDate

            };
            dataToSave.push(dataItem);
        }
        $http({
            method: 'POST',
            url: base_url + "Exam/Transaction/SaveUpdateClassTestMarkEntry",
            headers: { 'Content-Type': undefined },

            transformRequest: function(data) {

                var formData = new FormData();
                formData.append("jsonData", angular.toJson(data.jsonData));

                return formData;
            },
            data: { jsonData: dataToSave }
        }).then(function(res) {

            $scope.loadingstatus = "stop";
            hidePleaseWait();

            Swal.fire(res.data.ResponseMSG);

            if (res.data.IsSuccess == true) {
                $scope.ClearClassMarkEntry();

                //$scope.GetAllMarkEntryList();
            }

        }, function(errormessage) {
            hidePleaseWait();
            $scope.loadingstatus = "stop";

        });
    }
    $scope.GetAllMarkEntryList = function() {
        $scope.loadingstatus = "running";
        showPleaseWait();
        $scope.MarkEntryList = [];

        $http({
            method: 'POST',
            url: base_url + "Exam/Transaction/GetAllMarkEntryList",
            dataType: "json"
        }).then(function(res) {
            hidePleaseWait();
            $scope.loadingstatus = "stop";
            if (res.data.IsSuccess && res.data.Data) {
                $scope.MarkEntryList = res.data.Data;

            } else {
                Swal.fire(res.data.ResponseMSG);
            }

        }, function(reason) {
            Swal.fire('Failed' + reason);
        });

    }

    $scope.GetMarkEntryById = function(refData) {

        $scope.loadingstatus = "running";
        showPleaseWait();

        var para = {
            MarkEntryId: refData.MarkEntryId
        };

        $http({
            method: 'POST',
            url: base_url + "Exam/Transaction/GetMarkEntryById",
            dataType: "json",
            data: JSON.stringify(para)
        }).then(function(res) {
            hidePleaseWait();
            $scope.loadingstatus = "stop";
            if (res.data.IsSuccess && res.data.Data) {
                $scope.newMarkEntry = res.data.Data;
                $scope.newMarkEntry.Mode = 'Modify';

                //document.getElementById('MarkEntry-section').style.display = "none";
                //document.getElementById('MarkEntry-form').style.display = "block";

            } else {
                Swal.fire(res.data.ResponseMSG);
            }

        }, function(reason) {
            Swal.fire('Failed' + reason);
        });
    };

    $scope.DelMarkEntryById = function(refData) {

        Swal.fire({
            title: 'Do you want to delete the selected data?',
            showCancelButton: true,
            confirmButtonText: 'Delete',
        }).then((result) => {
            /* Read more about isConfirmed, isDenied below */
            if (result.isConfirmed) {
                $scope.loadingstatus = "running";
                showPleaseWait();

                var para = {
                    MarkEntryId: refData.MarkEntryId
                };

                $http({
                    method: 'POST',
                    url: base_url + "Exam/Transaction/DelMarkEntry",
                    dataType: "json",
                    data: JSON.stringify(para)
                }).then(function(res) {
                    hidePleaseWait();
                    $scope.loadingstatus = "stop";
                    if (res.data.IsSuccess) {
                        //$scope.GetAllMarkEntryList();
                    } else {
                        Swal.fire(res.data.ResponseMSG);
                    }

                }, function(reason) {
                    Swal.fire('Failed' + reason);
                });
            }
        });


    };




    //function for filter teacher on the basis of claswise
    $scope.GetClassTestClassWise = function() {
            $scope.loadingstatus = "running";
            showPleaseWait();

            var para = {
                ClassId: $scope.newClassMarkEntry.ClassId
            };
            $scope.ClassWiseTeasherList = [];

            $http({
                method: 'POST',
                url: base_url + "Exam/Transaction/GetClassTestClassWise",
                dataType: "json",
                data: JSON.stringify(para)
            }).then(function(res) {
                hidePleaseWait();
                $scope.loadingstatus = "stop";
                if (res.data.IsSuccess && res.data.Data) {
                    let uniqueData = [];
                    let seen = new Set();

                    res.data.Data.forEach(item => {
                        if (!seen.has(item.EmployeeId)) {
                            seen.add(item.EmployeeId);
                            uniqueData.push(item);
                        }
                    });

                    $scope.ClassWiseTeasherList = uniqueData;

                } else {
                    Swal.fire(res.data.ResponseMSG);
                }


            }, function(reason) {
                Swal.fire('Failed' + reason);
            });

        }
        //function for filter Subject on the basis of Teacher

    $scope.GetSubjectWiseTeacher = function() {
        $scope.loadingstatus = "running";
        showPleaseWait();
        var para = {
            EmployeeId: $scope.newClassMarkEntry.EmployeeId
        };
        $scope.SubjectWiseTeacherList = [];

        $http({
            method: 'POST',
            url: base_url + "Exam/Transaction/GetSubjectWiseTeacher",
            dataType: "json",
            data: JSON.stringify(para)
        }).then(function(res) {
            hidePleaseWait();
            $scope.loadingstatus = "stop";
            if (res.data.IsSuccess && res.data.Data) {
                let uniqueData = [];
                let seen = new Set();

                res.data.Data.forEach(item => {
                    if (!seen.has(item.EmployeeId)) {
                        seen.add(item.EmployeeId);
                        uniqueData.push(item);
                    }
                });

                $scope.SubjectWiseTeacherList = uniqueData;


            } else {
                Swal.fire(res.data.ResponseMSG);
            }

        }, function(reason) {
            Swal.fire('Failed' + reason);
        });

    }


    //function for filter Lesson on the basis of Subject

    $scope.GetCSubjectWiseLesson = function() {
        $scope.loadingstatus = "running";
        showPleaseWait();
        var para = {
            SubjectId: $scope.newClassMarkEntry.SubjectId
        };
        $scope.CSubjectWiseLessonList = [];

        $http({
            method: 'POST',
            url: base_url + "Exam/Transaction/GetCSubjectWiseLesson",
            dataType: "json",
            data: JSON.stringify(para)
        }).then(function(res) {
            hidePleaseWait();
            $scope.loadingstatus = "stop";
            if (res.data.IsSuccess && res.data.Data) {
                $scope.CSubjectWiseLessonList = res.data.Data;

            } else {
                Swal.fire(res.data.ResponseMSG);
            }

        }, function(reason) {
            Swal.fire('Failed' + reason);
        });

    }



    // $scope.GetClassSummaryClassWiseSubject = function() {
    //     $scope.loadingstatus = "running";
    //     showPleaseWait();

    //     var para = {
    //         ClassId: $scope.newSummary.ClassId
    //     };
    //     $scope.SubjectList = [];

    //     $http({
    //         method: 'POST',
    //         url: base_url + "Exam/Transaction/GetClassSummarySubjectClassWise",
    //         dataType: "json",
    //         data: JSON.stringify(para)
    //     }).then(function(res) {
    //         hidePleaseWait();
    //         $scope.loadingstatus = "stop";
    //         if (res.data.IsSuccess && res.data.Data) {
    //             $scope.SubjectList = res.data.Data;

    //         } else {
    //             Swal.fire(res.data.ResponseMSG);
    //         }

    //     }, function(reason) {
    //         Swal.fire('Failed' + reason);
    //     });

    // }




    //function for filter Student on the basis of Class

    $scope.GetStudentsDetailsClassWise = function() {
        $scope.loadingstatus = "running";
        showPleaseWait();

        //var para = {
        //	ClassId: $scope.newClassMarkEntry.ClassId,
        //};
        $scope.StudentsDetailsClassWiseList = [];

        $http({
            method: 'GET',
            url: base_url + "Exam/Transaction/GetStudentsDetailsClassWise?ClassId=" + $scope.newClassMarkEntry.ClassId,
            dataType: "json",
            //data: JSON.stringify(para)
        }).then(function(res) {
            hidePleaseWait();
            $scope.loadingstatus = "stop";
            if (res.data.IsSuccess && res.data.Data) {
                $scope.StudentsDetailsClassWiseList = res.data.Data;

            } else {
                Swal.fire(res.data.ResponseMSG);
            }

        }, function(reason) {
            Swal.fire('Failed' + reason);
        });

    }



    $scope.pageChangeHandler = function(num) {
        console.log('page changed to ' + num);
    };

});